<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Login</title>
    <link rel="stylesheet" href="styles.css">
  </head>

  <body>
    <h1 class="title">Login</h1>
    <div class="container">
      <span id="errorLog" class="hide error"></span>
      <div class="label-group">
        <label for="email">Email / Username:</label>
        <input id="usr" type="text" name="email" />
      </div>
      <div class="label-group">
        <label for="password">Password:</label>
        <input id="pass" type="password" name="password" />
      </div>
      <div>
        <button id="loginButton" class="btn" type="button" onclick="login()">Login</button>
      </div>
    </div>

    <script>
      var isLockedOut = false;
      var lockoutTime = 0;
      var loginAttempts = 0;
      function lock() {
        isLockedOut = true;
        setTimeout(unlock, 2 ** lockoutTime * 1000 * 60);
        let loginBtn = document.getElementById("loginButton");
        loginBtn.classList.add("disabled");
        loginBtn.disabled = true;
        error(1);
        lockoutTime++;
      }
      function unlock() {
        isLockedOut = false;
        loginAttempts = 0;
        let loginBtn = document.getElementById("loginButton");
        loginBtn.classList.remove("disabled");
        loginBtn.disabled = false;
      }
      function error(code) {
        let message;
        let errorLog = document.getElementById("errorLog");
        errorLog.classList.add("error");
        errorLog.classList.remove("success");
        switch (code) {
          default:
          case 1:
            message = `You have been locked out for ${2 **
              lockoutTime} minutes`;
            break;
          case 2:
            message = `Email or Password is incorrect. Attempts remaining: ${3 -
              loginAttempts}`;
            break;
          case 3:
            errorLog.classList.remove("error");
            errorLog.classList.add("success");
            message = "Login Successful!";
            break;
        }
        errorLog.classList.remove("hide");
        errorLog.innerHTML = message;
      }
      function login() {
        if (isLockedOut) {
          error(1);
        } else {
          var username = document.getElementById("usr").value;
          var password = document.getElementById("pass").value;
          const URL = `./cgi-bin/auth.py?username=${username}&password=${password}`;
          const params = {
            method: "GET"
          };
          fetch(URL, params)
            .then(response => {
              return response.json();
            })
            .then(data => {
              if (data.match) {
                lockoutTime = 0;
                loginAttempts = 0;
                error(3);
              } else {
                loginAttempts++;
                if (loginAttempts >= 3) lock();
                else error(2);
              }
            });
        }
      }
    </script>
  </body>
</html>
