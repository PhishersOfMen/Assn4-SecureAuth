<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Login</title>
  </head>

  <body>
    <h1>Login</h1>
    <div>
      <div>
        <span>Email / Username:</span>
        <input id="usr" type="text" name="email" />
      </div>
      <div>
        <span>Password:</span>
        <input id="pass" type="password" name="password" />
      </div>
      <div>
        <button id="loginButton" type="button" onclick="login()">Login</button>
      </div>
    </div>
    <div>
      <span id="errorLog"></span>
    </div>

    <script>
      var isLockedOut = false;
      var lockoutTime = 0;
      var loginAttempts = 0;
      function lock() {
        isLockedOut = true;
        setTimeout(unlock, 2 ** lockoutTime * 1000);
        document.getElementById("loginButton").disabled = true;
        error(
          `You have been locked out for ${2 ** lockoutTime * 1000} seconds`
        );
        lockoutTime++;
      }
      function unlock() {
        isLockedOut = false;
        loginAttempts = 0;
        document.getElementById("loginButton").disabled = false;
      }
      function error(message) {
        document.getElementById("errorLog").innerHTML = message;
      }
      function login() {
        if (isLockedOut) {
          error(
            `You have been locked out for ${2 ** lockoutTime * 1000} seconds`
          );
        } else {
          var username = document.getElementById("usr").value;
          var password = document.getElementById("pass").value;
          const URL = "./cgi-bin/auth.py";
          const params = {
            method: "POST",
            body: JSON.stringify({ username, password })
          };
          fetch(URL, params)
            .then(response => {
              console.log(response);
              return response.json();
            })
            .then(data => {
              if (data.match) {
                lockoutTime = 0;
                loginAttempts = 0;
                // LOGIN!
                console.log("SUCCESS!");
              } else {
                loginAttempts++;
                if (loginAttempts >= 3) lock();
                else
                  error(
                    `Email or Password is incorrect. Attempts remaining: ${3 -
                      loginAttempts}`
                  );
              }
            });
        }
      }
    </script>
  </body>
</html>
